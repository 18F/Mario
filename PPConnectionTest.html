<!DOCTYPE html>
<!-- This site was created in Webflow. http://www.webflow.com-->
<!-- Last Published: Tue Mar 11 2014 17:46:36 GMT+0000 (UTC) -->
<html data-wf-site="531e1ac95fe5f2ee6d0000c2">
  <head>
    <meta charset="utf-8">
  <title>Communicart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="css/normalize.css">
  <link rel="stylesheet" type="text/css" href="css/webflow.css">
  <link rel="stylesheet" type="text/css" href="css/communicart.webflow.css">
  <script>
    if (/mobile/i.test(navigator.userAgent)) document.documentElement.className += ' w-mobile';
  </script>
  <script src="file:///Users/RobertRead/projects/mario/jquery.min.js"></script>
  <script src="file:///Users/RobertRead/projects/mario/mariotype.js"></script>

  <link rel="shortcut icon" type="image/x-icon" href="https://y7v4p6k4.ssl.hwcdn.net/placeholder/favicon.ico">
  <!--[if lt IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->

  </head>
    <body>
 <div class="background-container">
    <div class="w-container main-container">
      <div>
        <div class="w-container">
          <h1>Q1 Supplies for Marketing Team</h1>
          <div class="w-row">
            <div class="w-col w-col-6 w-clearfix">
              <h2>Product List</h2>
              <div class="summary-list">
      <form>
	<div>
         <input id="small_search_string0"  type="text" placeholder="Item #1">
        <span id="price0"> </span>
	</div>
	<div>
         <input id="small_search_string1" type="text" placeholder="Item #2">
        <span id="price1"> </span>
	</div>
	<div>
         <input id="small_search_string2" type="text" placeholder="Item #3">
        <span id="price2"> </span>
	</div>
         <input type="button" id="searchButton" value="Search" onclick="performSearch();">
       </form>
              </div>

            </div>
            <div class="w-col w-col-6">
              <h2>Cart Summary</h2>
              <div class="summary-list">
                <div class="w-row cart-summary-row">
                  <div class="w-col w-col-9">
                    <p class="summary-link"><a href="http://#">GSA Advantage</a>
                    </p>
                  </div>
                  <div class="w-col w-col-3 summary-price-col">
                    <p><strong class="summary-price">$ 23.98</strong>
                    </p>
                  </div>
                </div>
                <div class="w-row cart-summary-row last">
                  <div class="w-col w-col-9">
                    <p class="summary-link"><u><a href="http://#">Staples Advantage</a></u>
                    </p>
                  </div>
                  <div class="w-col w-col-3">
                    <p><strong class="summary-price">$ 23.98</strong>
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div>
        <div>
          <div class="w-container comments">
            <div>
              <h4>Comments (3)</h4>
              <p><strong>Marsha on Feb 5, 2014</strong>
              </p>
              <p>This looks great. I will review and indicate which ones to go ahead and buy.</p>
              <p><strong>Jim on Feb 1, 2014</strong>
              </p>
              <p>Let me know what you think about these.</p>
              <p><strong>Marsha on Feb 1, 2014</strong>
              </p>
              <p>Hi Jim, Here is a list of supplies we’ll need for the team. Please fill out the details. I’m looking forward to see what you find! 1. Bic Pens (the kind we already have) – Qty 150 2. Notepads: Try something new this time. Maybe slightly
                smaller ones. People have said they don't like the 8.5 x 11 version.</p>
            </div>
          </div>
        </div>
      </div>
      <div>
        <div class="w-container results-header-container">
          <div>
            <h3>GSA Advantage</h3>
          </div>
        </div>
        <div class="w-container results-list">
          <div>
            <div class="w-row header">
              <div class="w-col w-col-2">
                <h5>Name</h5>
              </div>
              <div class="w-col w-col-2">
                <h5>Description</h5>
              </div>
              <div class="w-col w-col-2">
                <h5>Quantity</h5>
              </div>
              <div class="w-col w-col-2">
                <h5>Details</h5>
              </div>
              <div class="w-col w-col-2">
                <h5>Tags</h5>
              </div>
              <div class="w-col w-col-2">
                <h5>Price</h5>
              </div>
            </div>
          </div>
          <div class="w-row result-item">
            <div class="w-col w-col-2">
              <p><strong>Highlighters</strong>
              </p>
            </div>
            <div class="w-col w-col-2">
              <p>Initial description</p>
            </div>
            <div class="w-col w-col-2">
              <p>250</p>
            </div>
            <div class="w-col w-col-2">
              <p><strong>GSA Advantage</strong>
                <br><em>Item #ABC10593</em>
                <br><a href="http://#">Link to the product</a>
              </p>
            </div>
            <div class="w-col w-col-2">
              <p class="fssi-compliant result-tag">FSSI&nbsp;Compliant</p>
              <p class="result-tag">Eco-Friendly</p>
              <p class="result-tag">Made by Vets</p>
            </div>
            <div class="w-col w-col-2">
              <p class="result-item-price">$ 8.49</p>
              <p class="result-item-units">8 Units</p>
            </div>
          </div>
          <div class="w-row result-item">
            <div class="w-col w-col-2">
              <p><strong>Bic Pens</strong>
              </p>
            </div>
            <div class="w-col w-col-2">
              <p>Initial description</p>
            </div>
            <div class="w-col w-col-2">
              <p>250</p>
            </div>
            <div class="w-col w-col-2">
              <p><strong>GSA Advantage</strong>
                <br><em>Item #ABC10593</em>
                <br><a href="http://#">Link to the product</a>
              </p>
            </div>
            <div class="w-col w-col-2">
              <p class="result-tag fssi-compliant">FSSI&nbsp;Compliant</p>
              <p class="result-tag">Eco-Friendly</p>
              <p class="result-tag">Made by Vets</p>
            </div>
            <div class="w-col w-col-2">
              <p class="result-item-price">$ 8.49</p>
              <p class="result-item-units">8 Units</p>
            </div>
          </div>
          <div class="w-row total-price-row">
            <div class="w-col w-col-10 total-price">
              <p><strong>Total Price</strong>
              </p>
            </div>
            <div class="w-col w-col-2">
              <p><strong>$ 23.98</strong>
              </p>
            </div>
          </div>
          <div class="w-form">
            <form class="button-submit" name="email-form" data-name="Email Form">
              <input class="w-button form-button" type="submit" value="Send for Approval" data-wait="Sending..." wait="Sending..."></input>
            </form>
            <div class="w-form-done">
              <p>Thank you! Your submission has been received!</p>
            </div>
            <div class="w-form-fail">
              <p>Oops! Something went wrong while submitting the form :(</p>
            </div>
          </div>
        </div>
        <div class="w-container results-header-container">
          <div>
            <h3>Staples Advantage</h3>
          </div>
        </div>
        <div class="w-container results-list">
          <div>
            <div class="w-row header">
              <div class="w-col w-col-2">
                <h5>Name</h5>
              </div>
              <div class="w-col w-col-2">
                <h5>Description</h5>
              </div>
              <div class="w-col w-col-2">
                <h5>Quantity</h5>
              </div>
              <div class="w-col w-col-2">
                <h5>Details</h5>
              </div>
              <div class="w-col w-col-2">
                <h5>Tags</h5>
              </div>
              <div class="w-col w-col-2">
                <h5>Price</h5>
              </div>
            </div>
          </div>
          <div class="w-row result-item">
            <div class="w-col w-col-2">
              <p><strong>Highlighters</strong>
              </p>
            </div>
            <div class="w-col w-col-2">
              <p>Initial description</p>
            </div>
            <div class="w-col w-col-2">
              <p>250</p>
            </div>
            <div class="w-col w-col-2">
              <p><strong>GSA Advantage</strong>
                <br>Item #ABC10593
                <br><a href="http://#">Link to the product</a>
              </p>
            </div>
            <div class="w-col w-col-2">
              <p class="result-tag">Eco-Friendly</p>
              <p class="result-tag">Made by Vets</p>
            </div>
            <div class="w-col w-col-2">
              <p class="result-item-price">$10.49</p>
              <p class="result-item-units">8 Units</p>
            </div>
          </div>
          <div class="w-row result-item">
            <div class="w-col w-col-2">
              <p><strong>Bic Pens</strong>
              </p>
            </div>
            <div class="w-col w-col-2">
              <p>Initial description</p>
            </div>
            <div class="w-col w-col-2">
              <p>250</p>
            </div>
            <div class="w-col w-col-2">
              <p><strong>GSA Advantage</strong>
                <br>Item #ABC10593
                <br><a href="http://#">Link to the product</a>
              </p>
            </div>
            <div class="w-col w-col-2">
              <p class="result-tag">Eco-Friendly</p>
              <p class="result-tag">Made by Vets</p>
            </div>
            <div class="w-col w-col-2">
              <p class="result-item-price">$17.49</p>
              <p class="result-item-units">8 Units</p>
            </div>
          </div>
          <div>
            <div class="w-row total-price-row">
              <div class="w-col w-col-10 total-price">
                <p><strong>Total Price</strong>
                </p>
              </div>
              <div class="w-col w-col-2">
                <p><strong>$ 27.98</strong>
                </p>
              </div>
            </div>
          </div>
          <div class="w-form">
            <form class="button-submit" name="email-form" data-name="Email Form">
              <input class="w-button form-button" type="submit" value="Send for Approval" data-wait="Sending..." wait="Sending..."></input>
            </form>
            <div class="w-form-done">
              <p>Thank you! Your submission has been received!</p>
            </div>
            <div class="w-form-fail">
              <p>Oops! Something went wrong while submitting the form :(</p>
            </div>
          </div>
	<div id="summaryArea">
	  Total Price: <span id="summary_price"> </span>
	</div>
        <div>
          <h2>Cart Summary</h2>
          <div id="listcart_area">
          </div>
        </div>
      </div>
    </div>
  </div>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script type="text/javascript" src="js/webflow.js"></script>



  </html>

<script>
var ShoppingMalls = new Array();
ShoppingMalls[0] = "gsa";
ShoppingMalls[1] = "staples";
// code taken from stackoverflow
var qs = (function(a) {
    if (a == "") return {};
    var b = {};
    for (var i = 0; i < a.length; ++i)
    {
        var p=a[i].split('=');
        if (p.length != 2) continue;
        b[p[0]] = decodeURIComponent(p[1].replace(/\+/g, " "));
    }
    return b;
})(window.location.search.substr(1).split('&'));

// I sort of need to take these from the environment or from cookies
// or something---dont' have a great way of doing this at present.
session_id = qs["p3session_id"];
acsrf = qs["p3acsrf"];

username = qs["username"];
password = qs["password"];

// We hide the search button if you haven't got a session or a userid/password pair to work with
if (((typeof session_id === 'undefined') || 
    (typeof acsrf === 'undefined'))
    && 
(((typeof username === 'undefined') || 
    (typeof password === 'undefined')))) {
   document.getElementById('searchButton').style.display = 'none';
} 


$("#max").click(function () {

// Here we want to do a redirect or a form submission to
// get us to the P3 server to handle the GUI part, and 
// we need to tell it to redirect back to us here!

    window.location.replace("http://127.0.0.1/apisolr/GetTokensViaMax?redirectbackto=http://127.0.0.1/microApiUser/TestPage.html");

});


var standardFieldDescriptor = [];
standardFieldDescriptor["score"] = "Query Relevance";
standardFieldDescriptor["unitPrice"] = "Unit Price";
standardFieldDescriptor["unitsOrdered"] = "Units Ordered";
standardFieldDescriptor["orderDate"] = "Date";
standardFieldDescriptor["vendor"] = "Vendor";
standardFieldDescriptor["productDescription"] = "Product Description";
standardFieldDescriptor["longDescription"] = "Long Description";
standardFieldDescriptor["contractingAgency"] = "Contracting Agency";
standardFieldDescriptor["awardIdIdv"] = "Award ID/IDV";
standardFieldDescriptor["commodityType"] = "Commodity Type";
standardFieldDescriptor["psc"] = "PSC";

function numberWithCommas(x) {
    var parts = x.toString().split(".");
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    return parts.join(".");
}

function renderMicroRow(dataRow) {
	var html = "";
	html +=      ' <div class="result">';
	html +=      '<span class="vendor">'+ dataRow.vendor + ' </span>'; 

	html +=      '<span class="unitPrice">'+ '$'+numberWithCommas(dataRow.unitPrice)+ ' </span>'; 
	html +=      '<span class="result-details"> '+dataRow.productDescription.substring(0,60)+ ' </span>'; 
	html +=      '</div>';
        return html;
}

function renderMicroRowFromCatalogItem(ci) {
	var html = "";
	html +=      ' <div class="result">';
	html +=      '<span class="vendor">'+ ci.vendor + ' </span>'; 

	html +=      '<span class="unitPrice">'+ '$'+numberWithCommas(ci.unit_price)+ ' </span>'; 
	html +=      '<span class="result-details"> '+ci.description.substring(0,60)+ ' </span>'; 
	html +=      '</div>';
        return html;
}

function renderResultItem(ci) {
	var html = "";
        html +=   ' <div class="w-container results-list">';

	html +=      ' <div class="w-row result-item">';

        html +=     '<div class="w-col w-col-2">';
        html +=      '<p><strong>Query TBD</strong></p>';
        html +=     '</div>';

        html +=     '<div class="w-col w-col-2">';
        html +=      '<p><strong>'+ci.description.substring(0,60)+'</strong></p>';
        html +=     '</div>';

        html +=     '<div class="w-col w-col-2">';
        html +=      '<p><strong>250</strong></p>';
        html +=     '</div>';

        html +=     '<div class="w-col w-col-2">';
        html +=      '<p><strong>'+ci.description.substring(0,60)+'</strong></p>';
        html +=     '</div>';

        html +=     '<div class="w-col w-col-2">';
        html +=      '<p><strong>'+ci.vendor+'</strong></p>';
        html +=     '</div>';

        html +=     '<div class="w-col w-col-2">';
        html +=      '<p><strong>'+'$'+numberWithCommas(ci.unit_price)+'</strong></p>';
        html +=     '</div>';

	html +=      '</div>';
	html +=      '</div>';
        return html;
}

var apisolrurl = "http://127.0.0.1/apisolr";
var apisolrurlsession = "http://127.0.0.1/apisolr/session";
var global_number_of_results_to_return = "10";
var global_wishlist = new WishList();

// Here is where we will track the various carts.
// Eventually this will be highly expandable, but for now 
// this we will have two: GSA Advantage and Staples.
var list_carts = new Array();
list_carts[0] = new ListCart("GSA Advantage");
list_carts[0].clientdata = 0;
list_carts[0].modifyQuery = function (query) {
     return query + " " + "GSAdvantage";
}
list_carts[1] = new ListCart("Staples");
list_carts[1].clientdata = 1;
list_carts[1].modifyQuery = function (query) {
     return query + " " + "Staples";
}
list_carts[2] = new ListCart("Office Depot");
list_carts[2].clientdata = 2;
list_carts[2].modifyQuery = function (query) {
     return query + " " + "Office Depot";
}


render_listcarts();

// This relies on the clientdata having an standard index number.
function renderListCart(lc) {
     var html = "";

     html += "<form>\n";
     html += '<div class="w-container results-header-container">';
     html += '     <div>';
     html += '       <h3>'+lc.name+'</h3>';
     html += '     </div>';
     html += '   </div>';
     html += '     <div>';
     html += '       <div class="w-row header">';
     html += '         <div class="w-col w-col-2">';
     html += '           <h5>Name</h5>';
     html += '         </div>';
     html += '         <div class="w-col w-col-2">';
     html += '           <h5>Description</h5>';
     html += '         </div>';
     html += '         <div class="w-col w-col-2">';
     html += '           <h5>Quantity</h5>';
     html += '         </div>';
     html += '         <div class="w-col w-col-2">';
     html += '           <h5>Details</h5>';
     html += '         </div>';
     html += '         <div class="w-col w-col-2">';
     html += '           <h5>Tags</h5>';
     html += '         </div>';
     html += '         <div class="w-col w-col-2">';
     html += '           <h5>Price</h5>';
     html += '         </div>';
     html += '       </div>';
     html += '     </div>';


     html += "<p>"+lc.name+"</p>\n";
     var buttonId = "searchButton"+lc.clientdata;
     html += '<input type="button" id="'+buttonId+'" value="Search" onclick="performSearchForOneCart('+lc.clientdata+');">\n';
     html += '</form>\n';
     html += '<div id="listcart_area'+lc.clientdata+'">\n';
     html += '</div>\n';
     html += '     <div>';
     html += '       <div class="w-row total-price-row">';
     html += '         <div class="w-col w-col-10 total-price">';
     html += '           <p><strong>Total Price</strong>';
     html += '           </p>';
     html += '         </div>';
     html += '         <div class="w-col w-col-2">';
     html += '           <p><strong>$ 27.98</strong>';
     html += '           </p>';
     html += '         </div>';
     html += '       </div>';
     html += '     </div>';
     html += '     <div class="w-form">';
     html += '       <form class="button-submit" name="email-form" data-name="Email Form">';
     html += '         <input class="w-button form-button" type="submit" value="Send for Approval" data-wait="Sending..." wait="Sending..."></input>';
     html += '       </form>';
     html += '       <div class="w-form-done">';
     html += '         <p>Thank you! Your submission has been received!</p>';
     html += '       </div>';
     html += '       <div class="w-form-fail">';
     html += '         <p>Oops! Something went wrong while submitting the form :(</p>';
     html += '       </div>';
     html += '     </div>';
     return html;
}

function render_listcarts() {
      var listcart_area = $("#listcart_area");
//      listcart_area.empty();
      var len = list_carts.length;
      for (var i = 0; i < len; i++) {
         var ele = $('#listcart_area'+i);
	 lc = list_carts[i];
         listcart_area.append(renderListCart(lc));
       	 listcart_area.append("<div>* * *</div>");
      }
}

var global_research_results = new Array();

function performSearchForOneCart(id) {
   readGlobalWishList();
   var i = 0;
   var cd = ShoppingMalls[id]+ "X"+id;
   for(i = 0; i < global_wishlist.wish_items.length; i++) {
      var mod_query = list_carts[id].modifyQuery(global_wishlist.wish_items[i]);
      searchForItem(id,mod_query,global_number_of_results_to_return,
			'processAjaxSearchCallback');
    }
}

// This needs to be made dynamic...
function readGlobalWishList() {
    global_wishlist.wish_items[0] = $('#small_search_string0').val();
    global_wishlist.wish_items[1] = $('#small_search_string1').val();
    global_wishlist.wish_items[2] = $('#small_search_string2').val();
}

function performSearch() {
   for(var i = 0; i < list_carts.length; i++) {
       performSearchForOneCart(i);
   }
}

function searchForItem(index,query,num,callback) {
// We really need to figure out how to curry the query and the number into 
// the callback--should be easy in javascript, since it is so LISP-like
$.ajax({
    type: 'GET',
    url: apisolrurl,
    async: false,
    contentType: "application/json",
    dataType: 'jsonp',
    data: {
       p3username: username,
       p3password: password,
       numRows: num,
       search_string: query,
       psc_pattern: '*'
    },
    success: function (data) {
        processAjaxSearchCallback(data,index,name);
    },
    error: function(e) {
       alert("e.message = "+e.message);
       console.log(e.message);
    }
  });
}

function recalcTotal() {
// This needs to be computed from the research results...
   var total = 0.0;
   
   var arrayLength = global_research_results.length;
   for (var i = 0; i < arrayLength; i++) {
      var rr = global_research_results[i];
      if (rr) {
          total = total + rr.MeanUnitPrice();
      } else {
    // We haven't got the answer yet!
      }
   }
   $('#totalprice').html(""+total);   
   $('#summary_price').html(""+total);  
}

function processAjaxSearchCallback(dataFromSearch,index,name) {
   var rr = processAjaxSearch(dataFromSearch);
   global_research_results[index] = rr;
//   redrawDetailAreaFromResearchResult(rr,index,10);
   redrawDetailAreaFromResearchResultWithOneOnly(rr,index);
   recalcTotal();
}

function redrawDetailAreaFromResearchResult(rr,index,max) {
   var listcart_area = $("#listcart_area");
   var cd = list_carts[index].clientdata;
   var ele = $('#listcart_area'+cd);
//   ele.empty();
   var html = "";
   for (var i = 0; i < rr.orderItems.length && i < max; i++) {
       var ci = rr.orderItems[i].ci;
       html += renderResultItem(ci);
   }
   ele.append(html);
}

function redrawDetailAreaFromResearchResultWithOneOnly(rr,index) {
   redrawDetailAreaFromResearchResult(rr,index,1);
}

function processAjaxSearch(dataFromSearch) {
// If we timed out or failed to authenticate, we need to alert the user.
    if (!(dataFromSearch != null && typeof dataFromSearch === 'object')) {
		 alert("No results returned.");
		 return;
    }
    if ((typeof dataFromSearch) == 'undefined') {
		 alert("No results returned.");
		 return;
    }
    if (dataFromSearch[0] === undefined) {
		 alert("No results returned.");
		 return;
    }
		 
    if (dataFromSearch[0]["status"] && (dataFromSearch[0]["status"] == "BadAuthentication")) {
        alert("Unable to Authenticate. Probably your session timed-out. Please log in again.");	 
    }
    var rr = new ResearchResults();
    var i = 0;
    for (var key in dataFromSearch) {
        if (key != "clientdata") {
        var oi = new OrderItem();
        // This is improvable, basically, we want 
        // to build a good catalog item here...
        rr.orderItems[i] = oi;
        d = dataFromSearch[key];
        oi.ci.unit_price = parseFloat(d.unitPrice);
        oi.ci.vehicle = d.awardIdIdv;
        oi.ci.description = d.productDescription;
        oi.ci.vendor = d.vendor;
        i++;
        }
    }
    return rr;
}
</script>
