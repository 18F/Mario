<!DOCTYPE html>
  <html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Project Mario</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

  </head>
    <body>
<span>
      <h1>Product List</h1>
<!--      <script src="http://code.jquery.com/jquery.js"></script> -->
<!-- Obviously, this sucks, and needs to be replaced with somethin web hosted  -->
      <script src="file:///Users/RobertRead/projects/mario/jquery.min.js"></script>
      <script src="file:///Users/RobertRead/projects/mario/mariotype.js"></script>

      <form>
	<div>
         <input id="small_search_string0"  type="text" placeholder="Item #1">
        <span id="price0"> </span>
	</div>
	<div>
         <input id="small_search_string1" type="text" placeholder="Item #2">
        <span id="price1"> </span>
	</div>
	<div>
         <input id="small_search_string2" type="text" placeholder="Item #3">
        <span id="price2"> </span>
	</div>
         <input type="button" id="searchButton" value="Search" onclick="performSearch();">
       </form>
</span>
<span>
	<div id="summaryArea">
	         Total Price: <span id="summary_price"> </span>
	</div>
</span>

<h2>Cart Summary</h2>
<div id="listcart_area">
</div>

    </body>
  </html>

<script>
var ShoppingMalls = new Array();
ShoppingMalls[0] = "gsa";
ShoppingMalls[1] = "staples";
// code taken from stackoverflow
var qs = (function(a) {
    if (a == "") return {};
    var b = {};
    for (var i = 0; i < a.length; ++i)
    {
        var p=a[i].split('=');
        if (p.length != 2) continue;
        b[p[0]] = decodeURIComponent(p[1].replace(/\+/g, " "));
    }
    return b;
})(window.location.search.substr(1).split('&'));

// I sort of need to take these from the environment or from cookies
// or something---dont' have a great way of doing this at present.
session_id = qs["p3session_id"];
acsrf = qs["p3acsrf"];

username = qs["username"];
password = qs["password"];

// We hide the search button if you haven't got a session or a userid/password pair to work with
if (((typeof session_id === 'undefined') || 
    (typeof acsrf === 'undefined'))
    && 
(((typeof username === 'undefined') || 
    (typeof password === 'undefined')))) {
   document.getElementById('searchButton').style.display = 'none';
} 


$("#max").click(function () {

// Here we want to do a redirect or a form submission to
// get us to the P3 server to handle the GUI part, and 
// we need to tell it to redirect back to us here!

    window.location.replace("http://127.0.0.1/apisolr/GetTokensViaMax?redirectbackto=http://127.0.0.1/microApiUser/TestPage.html");

});


var standardFieldDescriptor = [];
standardFieldDescriptor["score"] = "Query Relevance";
standardFieldDescriptor["unitPrice"] = "Unit Price";
standardFieldDescriptor["unitsOrdered"] = "Units Ordered";
standardFieldDescriptor["orderDate"] = "Date";
standardFieldDescriptor["vendor"] = "Vendor";
standardFieldDescriptor["productDescription"] = "Product Description";
standardFieldDescriptor["longDescription"] = "Long Description";
standardFieldDescriptor["contractingAgency"] = "Contracting Agency";
standardFieldDescriptor["awardIdIdv"] = "Award ID/IDV";
standardFieldDescriptor["commodityType"] = "Commodity Type";
standardFieldDescriptor["psc"] = "PSC";

function numberWithCommas(x) {
    var parts = x.toString().split(".");
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    return parts.join(".");
}

function renderMicroRow(dataRow) {
	var html = "";
	html +=      ' <div class="result">';
	html +=      '<span class="vendor">'+ dataRow.vendor + ' </span>'; 

	html +=      '<span class="unitPrice">'+ '$'+numberWithCommas(dataRow.unitPrice)+ ' </span>'; 
	html +=      '<span class="result-details"> '+dataRow.productDescription.substring(0,60)+ ' </span>'; 
	html +=      '</div>';
        return html;
}
function renderMicroRowFromCatalogItem(ci) {
	var html = "";
	html +=      ' <div class="result">';
	html +=      '<span class="vendor">'+ ci.vendor + ' </span>'; 

	html +=      '<span class="unitPrice">'+ '$'+numberWithCommas(ci.unit_price)+ ' </span>'; 
	html +=      '<span class="result-details"> '+ci.description.substring(0,60)+ ' </span>'; 
	html +=      '</div>';
        return html;
}
var apisolrurl = "http://127.0.0.1/apisolr";
var apisolrurlsession = "http://127.0.0.1/apisolr/session";
var global_number_of_results_to_return = "10";
var global_wishlist = new WishList();

// Here is where we will track the various carts.
// Eventually this will be highly expandable, but for now 
// this we will have two: GSA Advantage and Staples.
var list_carts = new Array();
list_carts[0] = new ListCart("GSA Advantage");
list_carts[0].clientdata = 0;
list_carts[0].modifyQuery = function (query) {
     return query + " " + "GSAdvantage";
}
list_carts[1] = new ListCart("Staples");
list_carts[1].clientdata = 1;
list_carts[1].modifyQuery = function (query) {
     return query + " " + "Staples";
}
list_carts[2] = new ListCart("Office Depot");
list_carts[2].clientdata = 2;
list_carts[2].modifyQuery = function (query) {
     return query + " " + "Office Depot";
}


render_listcarts();

// This relies on the clientdata having an standard index number.
function renderListCart(lc) {
     var html = "";

     html += "<form>\n";
     html += "<p>"+lc.name+"</p>\n";
     var buttonId = "searchButton"+lc.clientdata;
     html += '<input type="button" id="'+buttonId+'" value="Search" onclick="performSearchForOneCart('+lc.clientdata+');">\n';
     html += '</form>\n';
     html += '<div id="listcart_area'+lc.clientdata+'">\n';
     html += '</div>\n';
     return html;
}

function render_listcarts() {
      var listcart_area = $("#listcart_area");
//      listcart_area.empty();
      var len = list_carts.length;
      for (var i = 0; i < len; i++) {
         var ele = $('#listcart_area'+i);
	 lc = list_carts[i];
         listcart_area.append(renderListCart(lc));
       	 listcart_area.append("<div>* * *</div>");
      }
}

var global_research_results = new Array();

function performSearchForOneCart(id) {
   readGlobalWishList();
   var i = 0;
   var cd = ShoppingMalls[id]+ "X"+id;
   debugger;
   for(i = 0; i < global_wishlist.wish_items.length; i++) {
      var mod_query = list_carts[id].modifyQuery(global_wishlist.wish_items[i]);
      searchForItem(id,mod_query,global_number_of_results_to_return,
			'processAjaxSearchCallback');
    }
}

// This needs to be made dynamic...
function readGlobalWishList() {
    global_wishlist.wish_items[0] = $('#small_search_string0').val();
    global_wishlist.wish_items[1] = $('#small_search_string1').val();
    global_wishlist.wish_items[2] = $('#small_search_string2').val();
}

function performSearch() {
   for(var i = 0; i < list_carts.length; i++) {
       performSearchForOneCart(i);
   }
}

function searchForItem(index,query,num,callback) {
// We really need to figure out how to curry the query and the number into 
// the callback--should be easy in javascript, since it is so LISP-like
alert("query"+query);
$.ajax({
    type: 'GET',
    url: apisolrurl,
    async: false,
    contentType: "application/json",
    dataType: 'jsonp',
    data: {
       p3username: username,
       p3password: password,
       numRows: num,
       search_string: query,
       psc_pattern: '*'
    },
    success: function (data) {
        processAjaxSearchCallback(data,index,name);
    },
    error: function(e) {
       alert("e.message = "+e.message);
       console.log(e.message);
    }
  });
}

function recalcTotal() {
// This needs to be computed from the research results...
   var total = 0.0;
   
   var arrayLength = global_research_results.length;
   for (var i = 0; i < arrayLength; i++) {
      var rr = global_research_results[i];
      if (rr) {
          total = total + rr.MeanUnitPrice();
      } else {
    // We haven't got the answer yet!
      }
   }
   $('#totalprice').html(""+total);   
   $('#summary_price').html(""+total);  
}

function processAjaxSearchCallback(dataFromSearch,index,name) {
   debugger;
   var rr = processAjaxSearch(dataFromSearch);
   global_research_results[index] = rr;
   redrawDetailAreaFromResearchResult(rr,index);
   recalcTotal();
}

function redrawDetailAreaFromResearchResult(rr,index) {
   var listcart_area = $("#listcart_area");
   var cd = list_carts[index].clientdata;
   var ele = $('#listcart_area'+cd);
//   ele.empty();
   var html = "";
   for (var i = 0; i < rr.orderItems.length; i++) {
       var ci = rr.orderItems[i].ci;
       html += renderMicroRowFromCatalogItem(ci);
   }
   ele.append(html);
}

function processAjaxSearch(dataFromSearch) {
// If we timed out or failed to authenticate, we need to alert the user.
    if (!(dataFromSearch != null && typeof dataFromSearch === 'object')) {
		 alert("No results returned.");
		 return;
    }
    if ((typeof dataFromSearch) == 'undefined') {
		 alert("No results returned.");
		 return;
    }
    if (dataFromSearch[0] === undefined) {
		 alert("No results returned.");
		 return;
    }
		 
    if (dataFromSearch[0]["status"] && (dataFromSearch[0]["status"] == "BadAuthentication")) {
        alert("Unable to Authenticate. Probably your session timed-out. Please log in again.");	 
    }
    var rr = new ResearchResults();
    var i = 0;
    for (var key in dataFromSearch) {
        if (key != "clientdata") {
        var oi = new OrderItem();
        // This is improvable, basically, we want 
        // to build a good catalog item here...
        rr.orderItems[i] = oi;
        d = dataFromSearch[key];
        oi.ci.unit_price = parseFloat(d.unitPrice);
        oi.ci.vehicle = d.awardIdIdv;
        oi.ci.description = d.productDescription;
        oi.ci.vendor = d.vendor;
        i++;
        }
    }
    return rr;
}
</script>
